<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Redirecting...</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background: linear-gradient(to bottom right, #f0f4ff, #ffffff);
      font-family: 'Segoe UI', sans-serif;
      color: #333;
      text-align: center;
    }

    .spinner {
      border: 6px solid #e0e0e0;
      border-top: 6px solid #3b82f6;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #ist-time {
      font-size: 14px;
      color: #666;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="spinner"></div>
  <h2>Hang tight...</h2>
  <p id="status">Checking time and selecting video...</p>
  <p id="ist-time"></p>

  <script>
    const API_KEY = 'AIzaSyCkWgPFPkJhnpeZxRgcwCUpt8bxpgqbNzg';

    const CALVARY_CHANNEL_ID = 'UC9TN8IPrNdTEARAqAkJFE8g';
    const CRF_GOSPEL_CHANNEL_ID = 'UC1NV48zXdJnG6oQ4NtjsELA';

    function getISTTime() {
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000); // convert to UTC
      const ist = new Date(utc + (330 * 60000)); // add 5h30m for IST
      return ist;
    }

    function getISTHour() {
      return getISTTime().getHours();
    }

    function showISTTime() {
      const time = getISTTime().toLocaleTimeString('en-IN');
      document.getElementById('ist-time').innerText = `Indian Time: ${time}`;
    }
    setInterval(showISTTime, 1000);
    showISTTime();

    async function isCalvaryLiveNow() {
      const url = `https://www.googleapis.com/youtube/v3/search?key=${API_KEY}&channelId=${CALVARY_CHANNEL_ID}&part=snippet&eventType=live&type=video`;
      const res = await fetch(url);
      const data = await res.json();
      return data.items && data.items.length > 0 ? data.items[0].id.videoId : null;
    }

    function getTargetChannelId() {
      const hour = getISTHour();
      if (hour >= 10 && hour < 18) return CALVARY_CHANNEL_ID;
      return CRF_GOSPEL_CHANNEL_ID;
    }

    async function getLatestRegularVideo(channelId) {
      const searchUrl = `https://www.googleapis.com/youtube/v3/search?key=${API_KEY}&channelId=${channelId}&part=id&order=date&maxResults=10&type=video`;
      const searchRes = await fetch(searchUrl);
      const searchData = await searchRes.json();

      const videoIds = searchData.items.map(item => item.id.videoId).join(',');
      if (!videoIds) throw new Error("No video IDs found.");

      const detailsUrl = `https://www.googleapis.com/youtube/v3/videos?key=${API_KEY}&id=${videoIds}&part=snippet,liveStreamingDetails`;
      const detailsRes = await fetch(detailsUrl);
      const detailsData = await detailsRes.json();

      const regularVideos = detailsData.items.filter(video => {
        const live = video.liveStreamingDetails;
        const isLiveNow = live && !live.actualEndTime;
        const isPastLive = live && live.actualEndTime;
        return !isLiveNow && !isPastLive;
      });

      if (regularVideos.length === 0) {
        throw new Error("No suitable non-live videos found.");
      }

      return regularVideos[0].id;
    }

    async function redirectToCorrectVideo() {
      try {
        const liveVideoId = await isCalvaryLiveNow();

        if (liveVideoId) {
          document.getElementById("status").innerText = "Calvary is live now â€” redirecting...";
          window.location.href = `https://www.youtube.com/watch?v=${liveVideoId}`;
          return;
        }

        const channelId = getTargetChannelId();
        document.getElementById("status").innerText = `Checking latest video from ${
          channelId === CALVARY_CHANNEL_ID ? "Calvary Prayer Fellowship" : "CRF Gospel"
        }...`;

        const latestVideoId = await getLatestRegularVideo(channelId);
        window.location.href = `https://www.youtube.com/watch?v=${latestVideoId}`;
      } catch (err) {
        document.getElementById("status").innerText = "Oops! Something went wrong.";
        console.error(err);
      }
    }

    window.onload = redirectToCorrectVideo;
  </script>
</body>
</html>
